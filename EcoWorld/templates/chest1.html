{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box Animation</title>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@v0.149.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@v0.149.0/examples/jsm/"
          }
        }
      </script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/FBXLoader.js"></script> -->
    <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js"></script> -->

</head>
<body style="margin: 0; overflow: hidden;">
    <h1> hello world </h1>


<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
let scene, camera, renderer;
let box, lid, smallBox;
let isOpened = false;
let GLTF;
let animations;
function loadModel() {
    const loader = new GLTFLoader();
    loader.load("{% static 'models/scene.gltf' %}", (gltf) => {
        scene.add(gltf.scene);
        GLTF = gltf;
        box = gltf.scene.getObjectByName('Box');
        lid = gltf.scene.getObjectByName('Lid');
        animations = gltf.animations;
        // smallBox = gltf.scene.getObjectByName('SmallBox');
    });
}
function init() {
    // Setup Scene
    scene = new THREE.Scene();

    // Camera
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(-300, 50, 0);
    //     camera.position.set(-500, 50, 20);
        camera.rotation.y -= Math.PI / 2; // Rotate by 22.5 degrees

    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(-300, 50, 5);
    scene.add(light);

    // // Create the Main Box (Container)
    // const boxMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
    // box = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), boxMaterial);
    // scene.add(box);

    // // Create the Lid (Separate Top)
    // lid = new THREE.Mesh(new THREE.BoxGeometry(2, 0.1, 2), boxMaterial);
    // lid.position.set(0, 1, 0); // Position on top of the main box
    // scene.add(lid);
    loadModel();
    // Create the Small Box Inside
    const smallBoxMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
    smallBox = new THREE.Mesh(new THREE.BoxGeometry(1, 50, 25), smallBoxMaterial);
    smallBox.position.set(0, 0.5, 0); // Inside the main box
    scene.add(smallBox);

    // Listen for Click Event
    window.addEventListener("click", openBox);

    animate();
}
let mixer;
// function openBox() {
//     if (!isOpened) {
//         isOpened = true;
        
//         mixer = new THREE.AnimationMixer(GLTF.scene);
//         console.log("playing animation");
//         console.log(animations);
//         // Iterate over all animations and play them
//         animations.forEach((clip) => {
//             mixer.clipAction(clip).play();
//         });
//         // Animate the lid opening
//         // gsap.to(lid.rotation, { duration: 1, x: Math.PI / 2, ease: "power2.out" });

//         // Animate the small box flying out and landing in front of the camera
//         gsap.to(smallBox.position, { 
//             duration: 1, 
//             y: 100,   // Moves up first
//             ease: "power2.out",
//             onComplete: () => { 
//                 gsap.to(smallBox.position, { 
//                     duration: 1.5, 
//                     y: 0,   // Comes back down
//                     x: -100,  // Moves toward the camera
//                     ease: "bounce.out"
//                 });
//             }
//         });
//     }
// }

function openBox() {
    if (!isOpened) {
        isOpened = true;

        mixer = new THREE.AnimationMixer(GLTF.scene);
        console.log("playing animation");
        console.log(animations);

        // Play the animations only once
        animations.forEach((clip) => {
            let action = mixer.clipAction(clip);
            action.loop = THREE.LoopOnce;  // Ensures the animation plays once
            action.clampWhenFinished = true;  // Makes sure the animation stops at the last frame
            action.play();
        });

        // Listen for the animation finish
        mixer.addEventListener("finished", () => {
            console.log("Box animation complete, now animating small box...");
            animateSmallBox();
        });
    }
}

function animateSmallBox() {
    gsap.to(smallBox.position, { 
        duration: 1, 
        y: 100,   // Moves up first
        ease: "power2.out",
        onComplete: () => { 
            gsap.to(smallBox.position, { 
                duration: 1.5, 
                y: 0,   // Comes back down
                x: -100,  // Moves toward the camera
                ease: "bounce.out"
            });
        }
    });
}

function animate() {
    requestAnimationFrame(animate);
    if (mixer) mixer.update(0.01); // Update the mixer for each frame

    renderer.render(scene, camera);
}

init();
</script>

<script type="module">
    // import * as THREE from 'three';
    // import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // let scene, camera, renderer, mixer, clock;
    // let model, lid, smallBox;
    // let isOpened = false;

    // function init() {
    //     // Scene setup
    //     scene = new THREE.Scene();
    //     scene.background = new THREE.Color(0x202020);

    //     // Camera setup
    //     camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    //     camera.position.set(-500, 50, 20);
    //     camera.rotation.y -= Math.PI / 2; // Rotate by 22.5 degrees
    //     // Renderer setup
    //     renderer = new THREE.WebGLRenderer({ antialias: true });
    //     renderer.setSize(window.innerWidth, window.innerHeight);
    //     document.body.appendChild(renderer.domElement);

    //     // Lighting
    //     const light = new THREE.DirectionalLight(0xffffff, 1);
    //     light.position.set(-500, 50, 20);
    //     scene.add(light);

    //     // Clock for animations
    //     clock = new THREE.Clock();

    //     // Load the 3D model (change 'models/chest.glb' to your model path)
    //     const loader = new GLTFLoader();
    //     loader.load("{% static 'models/scene.gltf' %}", (gltf) => {
    //         model = gltf.scene;
    //         // scene.add(model);

    //         // Assuming your model has a lid and small box, you can target those parts
    //         lid = model.getObjectByName('Lid'); // Use the actual name of the lid part from the model
    //         // smallBox = model.getObjectByName('SmallBox'); // Use the actual name of the small box part from the model
    //         const smallBoxMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });

    //         smallBox = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), smallBoxMaterial);
    //         smallBox.position.set(0, 0.5, 0); // Inside the main box
    //         scene.add(smallBox);
    //         if (lid) {
    //             lid.position.y = 1; // Adjust the lid position if necessary
    //         }

    //         // Set up the animation mixer for the model (if it has animations)
    //         mixer = new THREE.AnimationMixer(model);
    //         gltf.animations.forEach((clip) => {
    //             mixer.clipAction(clip).play();
    //         });
    //     }, undefined, (error) => {
    //         console.error("Error loading model: ", error);
    //     });

    //     // Listen for Click Event to trigger the box animation
    //     window.addEventListener("click", openBox);

    //     // Start the render loop
    //     animate();
    // }

    // function openBox() {
    //     if (!isOpened && lid && smallBox) {
    //         isOpened = true;

    //         // Animate the lid opening (you may need to adjust this depending on your model's lid)
    //         gsap.to(lid.rotation, { duration: 1, x: Math.PI / 2, ease: "power2.out" });

    //         // Animate the small box flying out and landing in front of the camera
    //         gsap.to(smallBox.position, {
    //             duration: 1,
    //             y: 300,   // Moves up first
    //             ease: "power2.out",
    //             onComplete: () => {
    //                 gsap.to(smallBox.position, {
    //                     duration: 1.5,
    //                     y: -40,   // Comes back down
    //                     z: 30,     // Moves towards the camera
    //                     ease: "bounce.out"
    //                 });
    //             }
    //         });
    //     }
    // }

    // function animate() {
    //     requestAnimationFrame(animate);

    //     if (mixer) mixer.update(clock.getDelta()); // Update the animations

    //     renderer.render(scene, camera);
    // }

    // // Handle window resize
    // window.addEventListener('resize', () => {
    //     camera.aspect = window.innerWidth / window.innerHeight;
    //     camera.updateProjectionMatrix();
    //     renderer.setSize(window.innerWidth, window.innerHeight);
    // });

    // // Initialize the scene
    // init();
</script>
</body>
</html>